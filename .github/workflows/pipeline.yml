name: Monitoring Lab Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  compose-validate:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ADMIN_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Validate docker compose
        run: docker compose config >/dev/null

  stack-up:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ADMIN_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
      GRAFANA_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
    needs: compose-validate
    steps:
      - uses: actions/checkout@v4
      - name: Start monitoring stack
        run: docker compose up -d
      - name: Wait for services to be reachable
        run: |
          SMOKE_RETRIES=30 SMOKE_SLEEP_SECONDS=2 ./scripts/smoke.sh
      - name: Show running services
        run: docker compose ps

  health-check:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ADMIN_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
      GRAFANA_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
    needs: stack-up
    steps:
      - uses: actions/checkout@v4
      - name: Start monitoring stack
        run: docker compose up -d
      - name: Run smoke checks
        run: ./scripts/smoke.sh

  lint-config:
    runs-on: ubuntu-latest
    env:
      GRAFANA_ADMIN_USER: ${{ vars.GRAFANA_ADMIN_USER }}
      GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
    needs: health-check
    steps:
      - uses: actions/checkout@v4
      - name: Check script syntax
        run: bash -n scripts/smoke.sh
      - name: Check dashboard JSON syntax
        run: jq . grafana/dashboards/infrastructure-health.json >/dev/null
      - name: Check Prometheus config using promtool
        run: |
          docker run --rm \
            -v "$PWD/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro" \
            --entrypoint=promtool prom/prometheus:v2.54.1 \
            check config /etc/prometheus/prometheus.yml
